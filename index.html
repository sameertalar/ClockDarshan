<!DOCTYPE html>
<html>
  <head>
    <title>Be Here Now</title>
    <link rel="icon" href="favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="shortcut icon" href="./img/clockDarshan.png" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />
    <!-- <link rel="stylesheet" href="../libraries/bootstrap.min.css" />-->
    <link rel="stylesheet" href="lib/clock.darshan.css?v=003" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <style></style>
  </head>
  <body>
    <div class="container-fluid screen-border">
      <div class="row">
        <!-- Left  container-->
        <div class="col-lg-4">
          <div class="text-center">
            <div id="clockContainer">
              <div id="clock-container">
                <svg id="clock" viewBox="0 0 100 100">
                  <defs>
                    <linearGradient id="Gradient1">
                      <stop class="stop1" offset="0%" />
                      <stop class="stop2" offset="50%" />
                      <stop class="stop3" offset="100%" />
                    </linearGradient>
                    <linearGradient id="Gradient2" x1="0" x2="0" y1="0" y2="1">
                      <stop offset="0%" stop-color="red" />
                      <stop offset="50%" stop-color="black" stop-opacity="0" />
                      <stop offset="100%" stop-color="blue" />
                    </linearGradient>
                  </defs>
                  <circle id="face" cx="50" cy="50" r="60" />
                  <g transform="translate(50, 50)">
                    <circle
                      id="ClockInnerCircle"
                      cx="0"
                      cy="0"
                      r="5"
                      style="
                        fill: #0d2931;
                        stroke: #58727a;
                        stroke-width: 25;
                        stroke-dasharray: 31, 10;
                      "
                    >
                      <animateTransform
                        attributeType="xml"
                        attributeName="transform"
                        type="rotate"
                        from="0"
                        to="360"
                        begin="0"
                        dur="18s"
                        repeatCount="indefinite"
                      />
                    </circle>
                  </g>
                  <text id="currentTime" x="46.5" y="50">Be Here Now</text>
                  <g id="hands">
                    <rect
                      id="min"
                      x="48.5"
                      y="21"
                      width="5"
                      height="15"
                      rx="7"
                      ry="7"
                    />
                    <rect
                      id="hour"
                      x="48.5"
                      y="21"
                      width="7"
                      height="7"
                      rx="7"
                      ry="7"
                    />
                    <rect
                      id="onepointer"
                      x="48.5"
                      y="19"
                      width="4"
                      height="27"
                      rx="2"
                      ry="2"
                    />
                  </g>
                </svg>
              </div>
            </div>
            <!--  Progress-Start -->
            <div class="alert alert-success text-center" id="success-alert">
              <span id="alertMessage" class="text-danger"> </span>
            </div>
            <div
              class="alert alert-warning text-center"
              style="display: none"
              id="progress-loading"
            >
              <h3>
                <!--  <i class="fa fa-spinner fa-spin text-primary"></i> -->
                <span
                  class="spinner-border text-primary"
                  id="spinner"
                  role="status"
                ></span>
              </h3>
            </div>

            <!--  Progress-End -->
         
            <div id="containerRadios" >
              <div >
                <div class="mt-4">
                  <div class="form-row justify-content-center">
                    <div id="containerMind" class="col-xs-4   "></div>
                    <div id="containerEnergy" class="col-xs-4 pl-3   border-left border-right "></div>
                    <div id="containerWork" class="col-xs-4 pl-3  "></div>  
                    <div>
                 

                    </div>            
                  </div>

                </div>
              </div>         
            </div>
  
            <div id="containerControls2" class="mt-2 ">
              <div class="text-center">
                <div class="btn-group">
                  <a
                    class="btn btn-info btn-lg active shrinkbtn"
                    data-toggle="collapse"
                    href="#collapseControlsSettings"
                    role="button"
                    aria-expanded="false"
                    aria-controls="collapseExample"
                  >
                    <i id="btnGear" class="fa fa-gear fa-2x"></i>
                  </a>
                  <button
                    id="btnTrackerSheetLoader"
                    type="button"
                    class="btn btn-info btn-lg active shrinkbtn"
                  >
                    <i class="fa fa-bar-chart"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="desktopMini">
              <div class="text-center">
                <span id="errorMessage" class="text-secondary small">
                  Be Here Now
                </span>
              </div>
            </div>
          </div>
        </div>
        <!-- Left  container end -->
        <!-- Right  container-->
        <div class="col-lg-8">
          <div>
            <div>
              <!-- Settings collapse  begin -->
              <div class="collapse" id="collapseControlsSettings">
                <div class="card card-body">
                  <!-- Settings Begin -->
                  <div>
                    <div class="form-group">
                      <button
                        id="btnResetSheetk"
                        type="button"
                        class="btn btn-primary btn-lg active shrinkbtn"
                      >
                        <i class="fa fa-random"></i> Reset Sheet
                      </button>

                      <button
                      id="btnPopup"
                      type="button"
                      class="btn btn-primary ml-5 btn-lg active shrinkbtn"
                    >
                      <i class="fa fa-window-restore"></i> Pop Up
                    </button>
                    </div>
                  </div>
                  <!-- Settings End -->
                </div>
              </div>
              <!--  Settings collapse  end -->
              <!-- Tracker Sheet  begin -->
              <div
                class="text-center border rounded"
                id="containerTrackerSheet"
                style="display: none"
              >
                <div
                  id="containerTrackerSheetscroll"
                  class="border border-primary"
                  style="height: 600px; overflow-y: scroll"
                >
                  <iframe
                    id="frameTrackerSheet"
                    src=""
                    title="Tracker Sheet"
                    style="border: none"
                    width="100%"
                    height="800"
                  >
                  </iframe>
                </div>
              </div>
              <!-- Tracker Sheet  end -->
            </div>
          </div>
          <div>
            <div class="text-center desktopMini">
              <!-- Buttons second row-->
              <!-- Buttons 2nd row end-->
            </div>
          </div>
        </div>
        <!-- Right  container end -->
      </div>
    </div>
    <!--
         <script src="../libraries/jquery-3.5.1.min.js"></script>
         <script src="../libraries/popper.min.js"></script>
         <script src="../libraries/bootstrap.min.js"></script>
         -->
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"
      integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s"
      crossorigin="anonymous"
    ></script>
    <script>
      $(document).ready(function () {
        const MEDIA_ROOT = "../ClockDarshanMedia/";
        var __AppEnabledStatus = false;
        var __ClockdarshanStatus = false;
        var __alertPlayIndicator = 0;
        var __dataConfig;

        // Load
        $("#btnTryChunk").on("click", tryChunkClick);
        $("#btnTrackerSheetLoader").on("click", loadTrackerSheetFrame);
        $("#ClockInnerCircle").on("click", oneClickTracker);
        $("#btnResetSheetk").on("click", oneClickResetSheet);
        $("#btnPopup").on("click", btnPopupClick);
        $("#success-alert").hide();
        console.log(
          "%cClock Darshan",
          "font-weight: bold; font-size: 50px; color: #ff4f51; text-shadow: 1px 1px 0px black, 1px -1px 0px black, -1px 1px 0px black, -1px -1px 0px black;"
        );

        $.getJSON("data/config.json?v=001", function (data) {
          __dataConfig = data;

          populateConfigSelectLists();
        });

        // Load End

        // Clock hands position
        __ClockdarshanStatus = setInterval(function () {
          function r(el, deg) {
            el.setAttribute("transform", "rotate(" + deg + " 50 50)");
          }
          var d = new Date();
          let hourDeg = 30 * (d.getHours() % 12) + d.getMinutes() / 2;
          let minDeg = 6 * d.getMinutes();

          r(hour, hourDeg);
          r(min, 6 * d.getMinutes());
          r(onepointer, getOnePointerDegree(hourDeg, minDeg));
        }, 1000);

        __AppEnabledStatus = setInterval(processBeHereNow, 1000);

        function setAlertAudioVolume(value) {
          $("#audioAlert")[0].volume = value;
          $("#rangeAlertAudioVolumeLabel").text(parseInt(value * 100) + "%");
        }

        function getOnePointerDegree(hourDeg, minDeg) {
          let hdeg = 15;
          let hrem = hourDeg % 90;

          let mrem = minDeg % 90;

          if (hrem >= 30) hdeg = 45;
          if (hrem >= 60) hdeg = 75;

          return minDeg - mrem + hdeg;
        }

        $.getJSON("data/audio.json", function (data) {
          __dataAudio = data;
          populateSelectAudioLists();
        });

        function populateSelectAudioLists() {
          $.each(__dataAudio.alerts, function (index, value) {
            $("#selectChunkBeforeAlertAudio").append(
              $("<option></option>")
                .attr("value", value.id)
                .text(value.text)
                .attr("data-filename", value.fileName)
            );
          });

          $("#selectChunkBeforeAlertAudio").prop("selectedIndex", 0);
        }

        function tryChunkClick() {
          let now = new Date();
          let min = now.getMinutes();
          let hours = now.getHours();
          playNotification(hours, min - (min % 5), 0, 0);
        }

        function btnPopupClick() {
          var myWindow = window.open(window.location.href, "", "width=250,height=250");
        }


        function processBeHereNow() {
          try {
            let now = new Date();
            let hours = now.getHours();
            let min = now.getMinutes();
            let sec = now.getSeconds();
            let ms = now.getMilliseconds() / 1000;

            // show Current Time
            showCurrentTime(hours, min, sec);

            // process
            if (min % 15 === 0 && sec === 1) {
              playNotification(hours, min, sec, ms);
              console.log(" 🔔***** Quarter (15 min) alert at ", new Date());
            }
          } catch (error) {
            console.log("Unhandled Error", error);
            $("#errorMessage").html("Unhandled Error: " + error);
          }
        }

        function playNotification(hours, minuteChunk, sec, ms) {
          __alertPlayIndicator = minuteChunk * 60 + sec;

          // 1.Before Alert
          playBeforeAlertAudio();
        }
        function playBeforeAlertAudio() {
          let fileName = $("#selectChunkBeforeAlertAudio")
            .find(":selected")
            .data("filename");

          let audioAlert = $("#audioAlert");

          if (fileName) {
            audioAlert.attr("src", MEDIA_ROOT + "alerts/" + fileName);
            audioAlert[0].play();
          } else {
            console.log("Audio alert is off. No file selected.");
          }
        }

        function loadTrackerSheetFrame() {
          if ($("#containerTrackerSheet").is(":visible")) {
            $("#frameTrackerSheet").attr("src", "");
            $("#containerTrackerSheet").hide(500);
          } else {
            $("#frameTrackerSheet").attr(
              "src",
              "https://docs.google.com/spreadsheets/d/1IeLBIUnPFC6-raeOoD1s80C-v8-Sl5rY1p38qFlQ0RY/edit#gid=1698318143"
            );

            $("#containerTrackerSheetscroll").height($(window).height() - 20);
            $("#frameTrackerSheet").height($(window).height() - 40);
            $("#containerTrackerSheet").show(500);
            $("#containerTrackerSheetscroll").scrollTop(100);
          }
        }

        function oneClickResetSheet() {
          $("#progress-loading").show();
          $("#success-alert").hide();

          let googleapireseturl =
            "https://script.google.com/macros/s/AKfycbzhx9voh2A2FOd-E2hR4-CFinQKV-R0X3CKvheKTBYa/dev?callback=?";

          $.ajax({
            crossOrigin: true,
            url: googleapireseturl,

            dataType: "jsonp",
            success: function (data, textStatus, xhr) {
              console.log("oneClickResetSheet response data", data);
              //alert('SUCCESS - ' + data)
              showAlert("<h2> Done : " + data + "</h2>");
              $("#progress-loading").hide();
            },
            error: function (xhr, error_text, statusText) {
              //alert('Sheet Reset Done with - ' + error_text)
              console.log("error_text", error_text);
              showAlert("<h2> Reset :" + error_text + "</h2>");
              $("#progress-loading").hide();
            },
          });
        }

        function oneClickTracker() {
          postToGoogle();
        }

        function postToGoogle() {
          $("#progress-loading").show();
          $("#success-alert").hide();

          let apiurl =
            "https://script.google.com/macros/s/AKfycbxJLoWhDykykVFykQfnvVAwri6wrYwU6xAIrhvOCGOh/dev";
          // Use Dev link no need to publish
          // "https://script.google.com/macros/s/AKfycbyOlFS1KprVp0UFfsfsjs8ibP-LbX4bnmDgKfy4s1qMUbaL6iLr/exec";

          let paramMind = $(".radioMind:checked").val(); // $("#selectMind option:selected").val();
          let paramEnergy = $(".radioEnergy:checked").val();
          let paramWork = $(".radioWork:checked").val();

          let now = new Date();
          let hours = now.getHours();
          let minutes = now.getMinutes();
          let quarter = 4;
          if (minutes < 45) {
            quarter = 3;
            if (minutes < 30) {
              quarter = 2;
              if (minutes < 15) {
                quarter = 1;
              }
            }
          }

          var paramtext = "&text=" + hours + "_" + minutes;

          let queryString =
            "?hour=" +
            hours +
            "&quarter=" +
            quarter +
            "&mind=" +
            paramMind +
            "&energy=" +
            paramEnergy +
            "&work=" +
            paramWork;

          console.log("queryString", queryString);

          let googleurl = apiurl + queryString + paramtext + "&callback=?";

          $.ajax({
            crossOrigin: true,
            url: googleurl,

            dataType: "jsonp",
            success: function (data, textStatus, xhr) {
              console.log(data);

              showAlert("<h2>" + data + "</h2>");
              console.log("response data", data);
              $("#progress-loading").hide();
            },
            error: function (xhr, error_text, statusText) {
              showAlert(error_text + "<br> Error while Processing");
              console.log("error_text", error_text);
              $("#progress-loading").hide();
            },
          });
        }

        function showAlert(text) {
          $("#alertMessage").html(text);
          $("#success-alert")
            .fadeTo(2000, 1500)
            .slideUp(15000, function () {
              $("#success-alert").slideUp(15000);
            });
        }

        function populateConfigSelectLists() {
          $.each(__dataConfig.notifyModes, function (index, value) {
            $("#selectChunkNotifyMode").append(
              $("<option></option>").attr("value", value.value).text(value.text)
            );
          });

          $.each(__dataConfig.trackerConfigs.mind, function (index, value) {
            /*
            $("#selectMind").append(
              $("<option></option>").attr("value", value.code).text(value.title)
            );
            */

            $("#containerMind")
              .append(`<div class="form-check form-check-inline mt-5 mr-0">`)
              .append(
                `<label class="form-check-label text-primary " for="${
                  value.code
                }">${value.title.substring(0, 2)}  </label>`
              )
              .append(
                `<input type="radio" class="radioMind form-check-input   mr-2   " id="radioMind${value.code}" name="radioMind" value="${value.code}">`
              )
              .append(`</div> `);
          });

          $("#radioMindA").prop("checked", true);

          $.each(__dataConfig.trackerConfigs.energy, function (index, value) {
            $("#containerEnergy")
              .append(`<div class="form-check form-check-inline text-warning  mt-5 mr-0">`)
              .append(
                `<label class="form-check-label " for="${
                  value.code
                }">${value.title.substring(0, 2)}  </label>`
              )
              .append(
                `<input type="radio" class="radioEnergy form-check-input   mr-2   " id="radioEnergy${value.code}" name="radioEnergy" value="${value.code}">`
              )
              .append(`</div> `);
          });

          $("#radioEnergyM").prop("checked", true);

          $.each(__dataConfig.trackerConfigs.work, function (index, value) {
            $("#containerWork")
              .append(`<div class="form-check form-check-inline  mt-5 mr-0">`)
              .append(
                `<label class="form-check-label " for="${
                  value.code
                }">${value.title.substring(0, 2)}  </label>`
              )
              .append(
                `<input type="radio" class="radioWork form-check-input  mr-2  " id="radioWork${value.code}" name="radioWork" value="${value.code}">`
              )
              .append(`</div> `);
          });

          $("#radioWorkK").prop("checked", true);
        }

        // ******* TIME Functions *******
        function showCurrentTime(hours, min, sec) {
          let hrs = hours % 12;
          var timeNow =
            //  (hrs === 0 ? "12" : pad(hrs, 2)) +   ":" +
            pad(min, 2) + ":" + pad(sec, 2);
          // +            " "
          // +            (hours > 12 ? "PM" : "AM");
          $("#currentTime").text(timeNow);
        }

        function pad(number, length) {
          var str = "" + number;
          while (str.length < length) {
            str = "0" + str;
          }

          return str;
        }
      });
    </script>
  </body>
</html>
