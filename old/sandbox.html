<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=6.0, user-scalable=1.0"
    />
    <!-- (c) Sameer Talar -->
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <title>Clock Darshan</title>
    <style>
      input[type="checkbox"] {
        /* Double-sized Checkboxes */
        -ms-transform: scale(1.7); /* IE */
        -webkit-transform: scale(1.7); /* Safari and Chrome */
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="sticky-top bg-light">
      <!--  fixed-top -->
      <div class="container-fluid">
        <div class="row">
          <div class="col-4">
            <button
              type="button"
              id="btnPostData"
              class="btn btn-lg btn-primary fs-1 p-5 float-left"
            >
              Update Data
            </button>
          </div>
          <div class="col-4">
            <span
              id="result"
              class="bg-info float-end fs-1 text-right border px-2"
              >üïâÔ∏è</span
            >
          </div>
          <div class="col-4 float-right">
            <button
              type="button"
              id="btnFixMissingData"
              class="btn btn-sm btn-danger fs-1 p-5 float-left"
            >
              Fix Missing
            </button>
          </div>
        </div>
      </div>
      <div
        class="alert alert-danger text-center fixed-top"
        style="display: none"
        id="progress-loading"
      >
        <h3>
          <!--  <i class="fa fa-spinner fa-spin text-primary"></i> -->
          <span
            class="spinner-border text-primary px-5 py-5"
            id="spinner"
            role="status"
          ></span>
        </h3>
      </div>
    </div>
    <div class="container-fluid" id="containerInputs">Loading Data....</div>
    <!-- Optional JavaScript; choose one of the two! -->
    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="https://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
         <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
         <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
         -->
    <script>
      function selectOnClick(ele) {
        console.log(ele.id);
        document.getElementById(ele.id.replace("Select", "F")).checked = true; // work - Duty
        document.getElementById(ele.id.replace("Select", "J")).checked = true; // Energy - Medium
        document.getElementById(ele.id.replace("Select", "Q")).checked = true; // Mind - Peamad
      }

      $(document).ready(function () {
        const _FromRowNumber = 28;
        const _ToRowNumber = 99;
        const _DataRange = "C28:AG99";
        const _ColumnSleep = "S";

        // On Page Load
        console.log("Jai Gagangiri!!");

        page_Load();
        $("#btnPostData").on("click", btnPostData_onClick);
        $("#btnFixMissingData").on("click", btnFixData_onClick);

        function page_Load() {
          // var testLink = $("<a target='_blank'>Link</a>").attr('href', "https://script.google.com/macros/s/AKfycby45MlbIOt0UYUqS4llQFW_CrMvvT-2n-aK-Ynbouk/dev");
          //  $("#result").html(testLink);
          getSheetTrackerData();
        }

        function getSheetTrackerData() {
          $("#progress-loading").show();

          try {
            google.script.run
              .withSuccessHandler(function (returnData) {
                console.log(returnData);

                // Create Eelements
                createTrackerElements(returnData);
                focusRow();
                $("#progress-loading").hide();
              })
              .getSheetData();
          } catch (err) {
            $("#progress-loading").hide();
            $("#containerInputs").html(err.message);
          }
        }

        function btnFixData_onClick() {
          $("#progress-loading").show();
          $("#result").html("");
          try {
            quartersSelected = "";

            let focusrownum = getfocusRowNumber();

            for (let j = _FromRowNumber; j <= focusrownum; j++) {
              let labelArrowClasses = $("#labelArrow" + j)
                .attr("class")
                .split(/\s+/);
              //console.log(j)
              //console.log(labelArrowClasses)

              if (labelArrowClasses.includes("bg-info")) {
                //console.log('TRUE')
              } else {
                $("#Select" + j).prop("checked", true);
                $("#F" + j).prop("checked", true); // work - Duty
                $("#J" + j).prop("checked", true); // Energy - Medium
                $("#Q" + j).prop("checked", true); // Mind - Peamad

                let quarter = $("#labelSelect" + j).text();

                quartersSelected = quartersSelected + quarter + ",";
                $("#result").html(quartersSelected);
              }
            }
          } catch (err) {
            $("#result").html(err.message);
          } finally {
            $("#progress-loading").hide();
          }
        }

        function btnPostData_onClick() {
          $("#progress-loading").show();
          $("#result").html("Processing......");

          try {
            let selectRows = 0;

            for (let j = _FromRowNumber; j <= _ToRowNumber; j++) {
              let checkSelected = $("#Select" + j + ":checked").val();
              let arrayCheckBoxes = [];

              if (checkSelected) {
                // console.log("Selected-", j, checkSelected);

                selectRows++;

                let checkSleep = $("#" + _ColumnSleep + j + ":checked").val();

                if (checkSleep) {
                  arrayCheckBoxes.push(checkSleep);
                  // console.log("        Sleep-", j, checkSleep);
                } else {
                  let workCheck = $(".radioWork" + j + ":checked").val();
                  let energyCheck = $(".radioEnergy" + j + ":checked").val();
                  let mindCheck = $(".radioMind" + j + ":checked").val();

                  if (workCheck) arrayCheckBoxes.push(workCheck);

                  if (energyCheck) arrayCheckBoxes.push(energyCheck);

                  if (mindCheck) arrayCheckBoxes.push(mindCheck);

                  //console.log("        Work-", j, workCheck);
                  // console.log("        Energy-", j, energyCheck);
                  //console.log("        Mind-", j, mindCheck);
                }

                console.log("Selected-", j, arrayCheckBoxes);
                google.script.run
                  .withSuccessHandler(function (ar) {
                    console.log(ar);
                    getSheetTrackerData();
                    $("#result").html(
                      "Success: " + selectRows + " row(s) affected."
                    );
                  })
                  .updateSheetData(j, arrayCheckBoxes);
              }

              if (selectRows == 0) $("#progress-loading").hide();
            }
          } catch (err) {
            $("#result").html(err.message);
          } finally {
            $("#progress-loading").hide();
          }
        }

        function getfocusRowNumber() {
          let now = new Date();
          let hour = now.getHours();
          let minutes = now.getMinutes();

          let rownum = getRowNumber(hour, minutes);

          return rownum;
        }

        function focusRow() {
          rownum = getfocusRowNumber();

          // $("#Select" + (rownum )).prop("checked", true);
          $("#Row" + rownum).addClass("bg-dark   font-italic ");
          $("#god" + rownum).addClass("strong text-white bg-primary    ");
          $("#Select" + rownum).focus();
        }

        function getRowNumber(hour, minutes) {
          let rowNumber = hour * 4 + 3;
          let quarter = 4;

          if (minutes < 45) {
            quarter = 3;

            if (minutes < 30) {
              quarter = 2;
              if (minutes < 15) {
                quarter = 1;
              }
            }
          }

          rowNumber = rowNumber + quarter;

          return rowNumber;
        }

        function createTrackerElements(returnData) {
          $("#containerInputs").html("");

          let focusrownum = getfocusRowNumber();
          missedRows = focusrownum - returnData.rowsLogged;

          if (returnData && returnData.rangeData) {
            for (let j = 0; j < returnData.rangeData.length; j++) {
              let bgColor = ` bg-secondary `;
              if (returnData.rangeData[j].index > 51) bgColor = `bg-danger `;
              if (returnData.rangeData[j].index > 75) bgColor = `bg-dark `;

              // Create element with HTML
              var row = $("<div></div>")
                .addClass("row ")
                .attr("id", "Row" + returnData.rangeData[j].index);
              var col = $("<div></div>").addClass("col-lg-12"); //.text("Text.") ;

              var trackL = $("<label></label>")
                .addClass(
                  "btn-lg   " +
                    (returnData.rangeData[j].track
                      ? "bg-info text-light"
                      : " bg-light text-secondary")
                )
                .text("‚Üì")
                .attr("for", "Select" + returnData.rangeData[j].index)
                .attr("id", "labelArrow" + returnData.rangeData[j].index);
              col.append(trackL);

              var timeL = $("<label></label>")
                .addClass(
                  `form-check-label btn-lg  border rounded  text-light ` +
                    bgColor
                )
                .text(returnData.rangeData[j].time)
                .attr("for", "Select" + returnData.rangeData[j].index)
                .attr("id", "labelSelect" + returnData.rangeData[j].index);
              var timeC = $("<input></input>")
                .attr("type", "checkbox")
                .addClass("form-check-input pt-2")
                .attr("id", "Select" + returnData.rangeData[j].index)
                .attr("autocomplete", "off")
                .attr("onchange", "selectOnClick(this); return false;");

              col.append(timeL);
              col.append(timeC);

              var workD = $("<div></div>")
                .addClass("btn-group btn-group-toggle ")
                .attr("data-toggle", "buttons");

              var work1R = $(
                "<input " + returnData.rangeData[j].C + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "C" + returnData.rangeData[j].index)
                .attr("name", "work" + returnData.rangeData[j].index)
                .addClass("btn-check radioWork" + returnData.rangeData[j].index)
                .attr("autocomplete", "off")
                .attr("value", "C" + returnData.rangeData[j].index);
              var work1L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-info border-0")
                .text("ü™î")
                .attr("for", "C" + returnData.rangeData[j].index);
              var work2R = $(
                "<input " + returnData.rangeData[j].D + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "D" + returnData.rangeData[j].index)
                .attr("name", "work" + returnData.rangeData[j].index)
                .addClass("btn-check radioWork" + returnData.rangeData[j].index)
                .attr("autocomplete", "off")
                .attr("value", "D" + returnData.rangeData[j].index);
              var work2L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-primary border-0")
                .text("üíé")
                .attr("for", "D" + returnData.rangeData[j].index);
              var work3R = $(
                "<input " + returnData.rangeData[j].E + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "E" + returnData.rangeData[j].index)
                .attr("name", "work" + returnData.rangeData[j].index)
                .addClass("btn-check radioWork" + returnData.rangeData[j].index)
                .attr("autocomplete", "off")
                .attr("value", "E" + returnData.rangeData[j].index);
              var work3L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-success border-0")
                .text("üåø")
                .attr("for", "E" + returnData.rangeData[j].index);
              var work4R = $(
                "<input " + returnData.rangeData[j].F + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "F" + returnData.rangeData[j].index)
                .attr("name", "work" + returnData.rangeData[j].index)
                .addClass("btn-check radioWork" + returnData.rangeData[j].index)
                .attr("autocomplete", "off")
                .attr("value", "F" + returnData.rangeData[j].index);
              var work4L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-warning border-0")
                .text("üë™")
                .attr("for", "F" + returnData.rangeData[j].index);
              var work5R = $(
                "<input " + returnData.rangeData[j].G + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "G" + returnData.rangeData[j].index)
                .attr("name", "work" + returnData.rangeData[j].index)
                .addClass("btn-check radioWork" + returnData.rangeData[j].index)
                .attr("autocomplete", "off")
                .attr("value", "G" + returnData.rangeData[j].index);
              var work5L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-danger border-0")
                .text("üçÇ")
                .attr("for", "G" + returnData.rangeData[j].index);

              workD.append(work1R);
              workD.append(work1L);
              workD.append(work2R);
              workD.append(work2L);
              workD.append(work3R);
              workD.append(work3L);
              workD.append(work4R);
              workD.append(work4L);
              workD.append(work5R);
              workD.append(work5L);

              col.append(workD);

              var energyD = $("<div></div>")
                .addClass(
                  "btn-group btn-group-toggle border border-secondary border-top-0 border-bottom-0"
                )
                .attr("data-toggle", "buttons");

              var energy1R = $(
                "<input " + returnData.rangeData[j].I + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "I" + returnData.rangeData[j].index)
                .attr("name", "energy" + returnData.rangeData[j].index)
                .addClass(
                  "btn-check radioEnergy" + returnData.rangeData[j].index
                )
                .attr("autocomplete", "off")
                .attr("value", "I" + returnData.rangeData[j].index);
              var energy1L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-success border-0")
                .text("üîã")
                .attr("for", "I" + returnData.rangeData[j].index);
              var energy2R = $(
                "<input " + returnData.rangeData[j].J + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "J" + returnData.rangeData[j].index)
                .attr("name", "energy" + returnData.rangeData[j].index)
                .addClass(
                  "btn-check radioEnergy" + returnData.rangeData[j].index
                )
                .attr("autocomplete", "off")
                .attr("value", "J" + returnData.rangeData[j].index);
              var energy2L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-warning border-0")
                .text("ü••")
                .attr("for", "J" + returnData.rangeData[j].index);
              var energy3R = $(
                "<input " + returnData.rangeData[j].K + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "K" + returnData.rangeData[j].index)
                .attr("name", "energy" + returnData.rangeData[j].index)
                .addClass(
                  "btn-check radioEnergy" + returnData.rangeData[j].index
                )
                .attr("autocomplete", "off")
                .attr("value", "K" + returnData.rangeData[j].index);
              var energy3L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-danger border-0")
                .text("‚ö™")
                .attr("for", "K" + returnData.rangeData[j].index);

              energyD.append(energy1R);
              energyD.append(energy1L);
              energyD.append(energy2R);
              energyD.append(energy2L);
              energyD.append(energy3R);
              energyD.append(energy3L);

              col.append(energyD);

              var mindD = $("<div></div>")
                .addClass("btn-group btn-group-toggle ")
                .attr("data-toggle", "buttons");

              var mind1R = $(
                "<input " + returnData.rangeData[j].N + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "N" + returnData.rangeData[j].index)
                .attr("name", "mind" + returnData.rangeData[j].index)
                .addClass("btn-check radioMind" + returnData.rangeData[j].index)
                .attr("autocomplete", "off")
                .attr("value", "N" + returnData.rangeData[j].index);
              var mind1L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-info border-0")
                .text("üïäÔ∏è")
                .attr("for", "N" + returnData.rangeData[j].index);
              var mind2R = $(
                "<input " + returnData.rangeData[j].O + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "O" + returnData.rangeData[j].index)
                .attr("name", "mind" + returnData.rangeData[j].index)
                .addClass("btn-check radioMind" + returnData.rangeData[j].index)
                .attr("autocomplete", "off")
                .attr("value", "O" + returnData.rangeData[j].index);
              var mind2L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-success border-0")
                .text("üßò")
                .attr("for", "O" + returnData.rangeData[j].index);
              var mind3R = $(
                "<input " + returnData.rangeData[j].P + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "P" + returnData.rangeData[j].index)
                .attr("name", "mind" + returnData.rangeData[j].index)
                .addClass("btn-check radioMind" + returnData.rangeData[j].index)
                .attr("autocomplete", "off")
                .attr("value", "P" + returnData.rangeData[j].index);
              var mind3L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-warning border-0")
                .text("üßø")
                .attr("for", "P" + returnData.rangeData[j].index);
              var mind4R = $(
                "<input " + returnData.rangeData[j].Q + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "Q" + returnData.rangeData[j].index)
                .attr("name", "mind" + returnData.rangeData[j].index)
                .addClass("btn-check radioMind" + returnData.rangeData[j].index)
                .attr("autocomplete", "off")
                .attr("value", "Q" + returnData.rangeData[j].index);
              var mind4L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-dark border-0")
                .text("üé≥")
                .attr("for", "Q" + returnData.rangeData[j].index);
              var mind5R = $(
                "<input " + returnData.rangeData[j].R + "></input>"
              )
                .attr("type", "radio")
                .attr("id", "R" + returnData.rangeData[j].index)
                .attr("name", "mind" + returnData.rangeData[j].index)
                .addClass("btn-check radioMind" + returnData.rangeData[j].index)
                .attr("autocomplete", "off")
                .attr("value", "R" + returnData.rangeData[j].index);
              var mind5L = $("<label></label>")
                .addClass("btn btn-lg btn-outline-danger border-0")
                .text("üî•")
                .attr("for", "R" + returnData.rangeData[j].index);

              mindD.append(mind1R);
              mindD.append(mind1L);
              mindD.append(mind2R);
              mindD.append(mind2L);
              mindD.append(mind3R);
              mindD.append(mind3L);
              mindD.append(mind4R);
              mindD.append(mind4L);
              mindD.append(mind5R);
              mindD.append(mind5L);

              col.append(mindD);

              var sleepC = $(
                "<input " + returnData.rangeData[j].S + " ></input>"
              )
                .attr("type", "checkbox")
                .addClass("btn-check")
                .attr("id", "S" + returnData.rangeData[j].index)
                .attr("autocomplete", "off")
                .attr("name", "S" + returnData.rangeData[j].index)
                .attr("value", "S" + returnData.rangeData[j].index);
              var sleepL = $("<label></label>")
                .addClass("btn  btn-lg btn-outline-danger")
                .text("X")
                .attr("for", "S" + returnData.rangeData[j].index);

              col.append(sleepC);
              col.append(sleepL);

              var godL = $("<label></label>")
                .addClass(
                  "small " +
                    (returnData.rangeData[j].track
                      ? " text-secondary"
                      : "  text-light")
                )
                .text(returnData.rangeData[j].god)
                .attr("id", "god" + returnData.rangeData[j].index);
              col.append(godL);

              row.append(col);

              $("#containerInputs").append(row);

              //   let row =createDiv("row", null, "Sameer");
              // $("#containerInputs").append([row]);
              //  document.getElementById("containerInputs").appendChild(row);
            }
          } else {
            $("#containerInputs").html(
              "Unhandled error while processing request."
            );
          }

          $("#result").html(missedRows + " Rows Missing");
        }
      });
    </script>
  </body>
</html>
